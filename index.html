<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Колесо фортуны</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      max-width: 100vw;
      max-height: 100vh;
      touch-action: none;
    }
    body {
      font-family: sans-serif;
      background: #19363D;
      color: white;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding-top: 16px;
    }
    .wheel-wrapper {
      position: relative;
      width: 260px;
      height: 260px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 130px auto 0 auto;
    }
    .canvas-holder {
      width: 100%;
      height: 100%;
      max-width: 90vmin;
      max-height: 90vmin;
      aspect-ratio: 1 / 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: visible;
      padding: 0;
      box-sizing: border-box;
      box-shadow: 0 -35px 50px 50px rgba(154, 255, 160, 0.5);
      border-radius: 50%;
    }
    .wheel img {
      width: 100%;
      border-radius: 50%;
      border: 4px solid white;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .spin-btn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      background-color: #ffcc00;
      color: #333;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .spin-btn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    /* --- Pulse Animation --- */
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    @keyframes spinAndPulse {
      0%   { transform: rotate(0deg) scale(1); }
      25%  { transform: rotate(360deg) scale(1.1); }
      50%  { transform: rotate(720deg) scale(1.2); }
      75%  { transform: rotate(1080deg) scale(1.1); }
      100% { transform: rotate(1440deg) scale(1); }
    }

    .spin-active {
      animation: spinAndPulse 2s linear forwards, pulse 1.5s infinite;
    }

    #spinBtn.spinning {
      animation: spinAndPulse 4s linear infinite;
    }
    .result-frame {
      position: fixed;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ffffff;
      color: #000;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      box-shadow: 0 0 30px 2px rgba(154, 255, 160, 0.3);
      z-index: 9999;
      text-align: center;
      min-width: 280px; /* или 360px, если нужно ещё больше */
    }

    .close-btn {
      position: absolute;
      top: 5px;
      right: 10px;
      cursor: pointer;
      font-size: 18px;
      color: #96D52B;
    }
    .pointer {
      position: absolute;
      top: -90px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 20px solid #fff;
      z-index: 10;
    }
    .center-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      cursor: pointer;
      z-index: 5;
    }
    .spin-overlay {
      position: absolute;
      top: 35%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.56);
      width: 80px;
      height: 80px;
      z-index: 6;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .spin-layer {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    .spin-layer.layer2 {
      transform: scale(0.85);
    }

    .spin-layer.layer3 {
      pointer-events: auto;
      cursor: pointer;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #DAFF9C;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Adaptive banner & wheel for mobile screens --- */
    @media (max-height: 720px), (max-width: 380px) {
      .promo-banner {
        transform: scale(0.7);
        top: 4px;
      }

      .wheel-wrapper {
        transform: scale(0.8);
        margin-top: 90px;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div id="loader" style="display: flex; align-items: center; justify-content: center; height: 100vh;">
      <div class="spinner"></div>
    </div>
    <div class="promo-banner" style="position: absolute; top: 20px; width: 315px; height: 91.74px; display: flex; flex-direction: column; align-items:center; justify-content: center; gap: 4px; ">
    <img src="banner-title.png" alt="WEBTOP" style="max-width: 100%; height: auto;" />
      <span style="font-family: 'Ubuntu', sans-serif; font-weight: 500; font-size: 18px; line-height: 100%; letter-spacing: 0%; text-align: center; text-transform: uppercase; color: white;">ЖМИ НА КОЛЕСО И ЗАБИРАЙ ПОДАРКИ</span>
    </div>
    <div id="mainContent" style="display: none;">
      <div class="wheel-wrapper">
        <div class="canvas-holder">
          <canvas id="fortuneWheel" width="420" height="420" style="margin-bottom: 80px;"></canvas>
        </div>
        <div class="pointer"></div>
        <div class="spin-overlay">
          <img src="Ellipse 1.png" class="spin-layer layer1" />
          <img src="Ellipse 2.png" class="spin-layer layer2" />
          <img src="Autorenew.png" id="spinBtn" class="spin-layer layer3" />
        </div>
      </div>
      <div class="info-box" style="position: relative; width: 310px; height: 50px; margin: 20px auto 0 auto; display: flex; flex-direction: column; gap: 10px; border-radius: 7px; padding: 12px 22px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(6px); border: 1px solid rgba(255, 255, 255, 0.15);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 12px;">Бесплатное вращение через</span>
          <span id="countdownTimer" style="font-family: 'Ubuntu', sans-serif; font-weight: 400; font-size: 17px; line-height: 100%; letter-spacing: 0%; color: #B2B2B2; ">--:--:--</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 12px;">Вращения за друзей</span>
          <span id="friendsCount" style="font-family: 'Ubuntu', sans-serif; font-weight: 400; font-size: 17px; line-height: 100%; letter-spacing: 0%; color: #96D52B;">0</span>
        </div>
      </div>
      <div style="margin-bottom: 12px; margin-top: 30px; font-size: 13px; color: #B2B2B2">Пригласите друзей для бесплатных вращений :</div>
        <button id="inviteBtnMain" style="width: 355px; background: transparent; border: 2px solid #96D52B; padding: 10px 16px; color: #96D52B; font-weight: bold; border-radius: 8px; cursor:pointer; font-family: 'Ubuntu', sans-serif;">Пригласить друзей</button>
      </div>
    </div>
  </div>
  <div id="resultOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background: rgba(0,0,0,0.6); z-index:9998;">
    <div class="result-frame" id="resultText" style="display: block;">
      <div id="resultContent"></div>
    </div>
  </div>

  <!-- Модальное окно "нет спинов" с затемняющим фоном -->
  <div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background: rgba(0,0,0,0.6); z-index:9998;">
    <div id="noSpinsModal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#1F2C29; color:white; padding:20px 30px; border-radius:12px; z-index:10000; text-align:center; font-family:'Ubuntu', sans-serif; width:260px; box-shadow: 0 0 30px 2px rgba(154, 255, 160, 0.3);">
      <img id="closeNoSpins" src="close.png" alt="Закрыть" style="position: absolute; top: 10px; right: 14px; width: 18px; height: 18px; cursor: pointer;" />
      <div style="font-family: 'Ubuntu', sans-serif; font-size: 18px; font-weight: bold; color: #DAFF9C; margin-bottom: 10px;">Упс... Спины закончились(</div>
      <img src="box.png" alt="box" style="width: 50px; margin: 14px auto;" />
      <div style="font-family: 'Ubuntu', sans-serif; font-size: 13px; color: white; margin: 12px 0;">Подожди некоторое время или пригласи друзей!</div>
      <div style="background: #445052; border-radius: 6px; padding: 6px 0; font-size: 12px; color: #ccc; margin-top: 14px;">
        До следующего спина
        <div id="modalCountdownTimer" style="font-family: 'Ubuntu', sans-serif; font-size: 20px; font-weight: bold; color: #96D52B; margin-top: 4px;">--:--:--</div>
      </div>
      <button id="inviteBtnModal" style="width: 260px; margin-top:14px; background: transparent; border: 2px solid #96D52B; padding: 10px 16px; color: #96D52B; font-weight: bold; border-radius: 8px; cursor:pointer; font-family: 'Ubuntu', sans-serif;">Пригласить друзей</button>
    </div>
  </div>
  <div id="toast" style="opacity:0; transition: opacity 0.5s ease; position:fixed; top:20px; left:50%; transform:translateX(-50%); background: rgba(79, 79, 79, 0.9); color:#fff; padding:8px 16px; border-radius:8px; font-size:14px; font-family:'Ubuntu', sans-serif; z-index:10001;">
        Ссылка скопирована
  </div>
  <!-- Модальное окно "разрешён спин" -->
  <div id="modalOverlayStart" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background: rgba(0,0,0,0.6); z-index:9998;">
    <div id="yesSpinModal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#1F2C29; color:white; padding:20px 30px; border-radius:12px; z-index:10000; text-align:center; font-family:'Ubuntu', sans-serif; width:290px; box-shadow: 0 0 30px 2px rgba(154, 255, 160, 0.3);">
      <img id="closeYesSpin" src="close.png" alt="Закрыть" style="position: absolute; top: 14px; right: 16px; width: 18px; height: 18px; cursor: pointer;" />
    <div style="font-family: 'Ubuntu', sans-serif; font-size: 22px; font-weight: 700; color: #D5FF73; margin-bottom: 10px;">ROLL-CAM</div>
    <div style="font-size: 13px; font-weight: 400; margin-bottom: 6px;">ПЕРВОЕ В МИРЕ КОЛЕСО<br>ВЕБКАМА!</div>
    <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 12px 18px; text-align: left;">
      <div style="font-family: 'Ubuntu', sans-serif; font-weight: 600; font-size: 14.5px; margin-bottom: 6px;">
        Крути и получай призы:
      </div>
      <div style="font-family: 'Ubuntu', sans-serif; font-weight: 400; font-size: 12px; line-height: 123%; letter-spacing: 0%;">
        • Продвижение на Stripchat<br/>
        • Продвижение на Chaturbate<br/>
        • Лайки для Chaturbate<br/>
        • Курс от ТОП-модели по выходу на высокие чеки
      </div>
      </div>
      <div style="margin-top: 12px; background: rgba(255,255,255,0.08); border-radius: 12px; padding: 12px 18px; text-align: left;">
        <div style="font-family: 'Ubuntu', sans-serif; font-weight: 600; font-size: 14.5px; margin-bottom: 6px;">
          1 вращение в 24 часа!
        </div>
        <div style="font-family: 'Ubuntu', sans-serif; font-weight: 400; font-size: 12px; line-height: 123%; letter-spacing: 0%;">
          Приведи друзей и получи 1 дополнительное<br/>вращение за каждого друга
        </div>
      </div>
    <button id="inviteBtnModalStart" style="margin-top: 16px; width: 100%; max-width: 350px; background: transparent; border: 2px solid #96D52B; padding: 12px 16px; color: #96D52B; font-weight: bold; border-radius: 8px; cursor:pointer; font-family: 'Ubuntu', sans-serif; font-size: 15px;">Пригласить друзей</button>
    <button id="startSpinBtn" style="margin-top: 12px; width: 100%; max-width: 350px; background: #96D52B; border: none; padding: 14px 16px; color: #1F2C29; font-weight: bold; border-radius: 8px; cursor:pointer; font-family: 'Ubuntu', sans-serif; font-size: 15px;">ПОГНАЛИ!</button>
    </div>
  </div>

  <script>
    const prizes = [
      { label: "Stripchat", image: "3.png" },
      { label: "Joke", image: "1.png" },
      { label: "Joke", image: "1.png" },
      { label: "Chaturbate", image: "2.png" },
      { label: "Joke", image: "1.png" },
      { label: "Joke", image: "1.png" },
      { label: "Stripchat", image: "3.png" },
      { label: "Joke", image: "1.png" },
      { label: "Joke", image: "1.png" },
      { label: "Chaturbate", image: "2.png" },
      { label: "Joke", image: "1.png" },
      { label: "Joke", image: "1.png" }
    ];

    const canvas = document.getElementById("fortuneWheel");
    const ctx = canvas.getContext("2d");
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 170;

    const loadedImages = {};

    function loadImages(callback) {
      let loadedCount = 0;
      prizes.forEach((p, i) => {
        const img = new Image();
        img.src = p.image;
        img.onload = () => {
          loadedImages[i] = img;
          loadedCount++;
          if (loadedCount === prizes.length) callback();
        };
        img.onerror = () => {
          loadedImages[i] = null;
          loadedCount++;
          if (loadedCount === prizes.length) callback();
        };
      });
    }

    function drawWheel() {
      const anglePerSector = (2 * Math.PI) / prizes.length;
      for (let i = 0; i < prizes.length; i++) {
        const startAngle = i * anglePerSector;
        const endAngle = startAngle + anglePerSector;

        // Сектор
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        let gradient;
        if (i % 2 === 0) {
          // Сектор с линейным градиентом: светло-зелёный
          gradient = ctx.createLinearGradient(
            centerX + Math.cos(startAngle) * radius,
            centerY + Math.sin(startAngle) * radius,
            centerX + Math.cos(endAngle) * radius,
            centerY + Math.sin(endAngle) * radius
          );
          gradient.addColorStop(0, "#DAFF9C");
          gradient.addColorStop(1, "#9BF3A0");
        } else {
          // Тёмно-зелёный сектор (без градиента)
          gradient = "#19363D";
        }
        ctx.fillStyle = gradient;
        ctx.fill();
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();

        // Изображение
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(startAngle + anglePerSector / 2);
        
        const img = loadedImages[i];
        if (img) {
            const maxWidth = 100;
            const scale = maxWidth / img.width;
            const finalWidth = img.width * scale;
            const finalHeight = img.height * scale;

            // Увеличение масштаба на 15%
            let zoom = 1.15; // базовое увеличение

            if (prizes[i].label === "Joke") {
              zoom *= 0.5;
            } else if (prizes[i].label === "Stripchat") {
              zoom *= 1;  // увеличим Stripchat дополнительно на 30%
            } else if (prizes[i].label === "Chaturbate") {
              zoom *= 0.7;  // можно чуть подправить и для других, если нужно
            }
            ctx.scale(zoom, zoom);
            let offsetX = 0;
            if (prizes[i].label === "Joke") {
              offsetX = radius * 1.3;
            } else if (prizes[i].label === "Stripchat") {
              offsetX = radius * 0.5;  // чуть дальше
            } else if (prizes[i].label === "Chaturbate") {
              offsetX = radius * 0.8; // чуть ближе к центру
            }
            ctx.translate(offsetX, 0);
            ctx.drawImage(img, -finalWidth / 2, -finalHeight / 2, finalWidth, finalHeight);
        } else {
          ctx.fillStyle = "white";
          ctx.font = "16px sans-serif";
          ctx.textAlign = "right";
          ctx.fillText(prizes[i].label, radius - 10, 5);
        }
        ctx.restore();
      }
    }

    let currentRotation = 0;

const spinDuration = 4; // seconds
document.getElementById("spinBtn").addEventListener("click", () => {
  const spinButton = document.getElementById("spinBtn");
  if (spinButton.disabled) return; // предотвратим повторный клик
  spinButton.style.pointerEvents = "none";
  spinButton.disabled = true;
  spinButton.classList.add("spinning");
      const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
      if (!tgUser || !tgUser.id) {
        const resultFrame = document.getElementById("resultText");
        const resultContent = document.getElementById("resultContent");
        resultContent.innerHTML = `
          <p>Пожалуйста, сначала нажмите "start" у бота в Telegram</p>
          <a href="https://t.me/rollcam_bot" target="_blank" style="color: #6C5CFE; font-weight: bold;">Нажмите сюда</a>
        `;
        resultFrame.style.display = "block";
        setTimeout(() => {
          resultFrame.style.display = "none";
        }, 10000);
        return;
      }

      const username = tgUser.username || "unknown";
      const userId = tgUser.id || "unknown";
      // const username = "unknown";
      // const userId = "unknown";

      fetch("https://api.ipify.org?format=json")
        .then(res => res.json())
        .then(data => {
          const ip = data.ip;
          // Если OK — тогда крутим
          const anglePerSector = (2 * Math.PI) / prizes.length;

      // 🎯 Теория вероятностей выпадения категорий:
      // 70% — Joke, 15% — Stripchat, 15% — Chaturbate
      // Выбираем категорию с заданной вероятностью
      const rand = Math.random();
      let targetLabel = "";
      if (rand < 0.7) targetLabel = "Joke";
      else if (rand < 0.85) targetLabel = "Stripchat";
      else targetLabel = "Chaturbate";

          // Собираем индексы всех секторов с нужной категорией
          const matchingIndexes = prizes
            .map((p, i) => (p.label === targetLabel ? i : -1))
            .filter(i => i !== -1);

          // Случайно выбираем один из подходящих индексов
          const targetIndex = matchingIndexes[Math.floor(Math.random() * matchingIndexes.length)];

          // Вычисляем нужный угол
          const targetAngle = 1.5 * Math.PI - (targetIndex + 0.5) * anglePerSector;

          // Добавляем обороты + точный угол
          const spinRadians = 2 * Math.PI * 5 + ((targetAngle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
          currentRotation += spinRadians;

          canvas.style.transition = `transform ${spinDuration}s ease-out`;
          canvas.style.transform = `rotate(${(currentRotation * 180) / Math.PI}deg)`;

          document.getElementById("spinBtn").style.transition = `transform ${spinDuration}s linear`;

          setTimeout(() => {
            const anglePerSector = (2 * Math.PI) / prizes.length;
            const pointerAngle = ((Math.PI * 1.5 - currentRotation) % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
            const prizeIndex = Math.floor(pointerAngle / anglePerSector) % prizes.length;
            const prizeLabel = prizes[prizeIndex].label;

            const resultFrame = document.getElementById("resultText");
            const resultContent = document.getElementById("resultContent");

            fetch("fortuna.json")
              .then(res => res.json())
              .then(data => {
                let finalText = "";

                if (prizeLabel === "Joke") {
                  const jokes = data.joke;
                  finalText = jokes[Math.floor(Math.random() * jokes.length)];
                } else if (prizeLabel === "Stripchat" || prizeLabel === "Chaturbate") {
                  const key = prizeLabel.toLowerCase(); // "stripchat" или "chaturbate"
                  const source = data[key];
                  const prizeRand = Math.random();
                  const pool = prizeRand < 0.9 ? source.prize : source.superprize;
                  const selected = pool[Math.floor(Math.random() * pool.length)];
                  finalText = `${prizeLabel}: ${selected}`;

                  // --- Конфетти для Stripchat и Chaturbate ---
                  const confettiCanvas = document.createElement("canvas");
                  confettiCanvas.style.position = "fixed";
                  confettiCanvas.style.top = 0;
                  confettiCanvas.style.left = 0;
                  confettiCanvas.style.width = "100vw";
                  confettiCanvas.style.height = "100vh";
                  confettiCanvas.style.pointerEvents = "none";
                  confettiCanvas.style.zIndex = 99999;
                  document.body.appendChild(confettiCanvas);

                  const script = document.createElement("script");
                  script.src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js";
                  script.onload = () => {
                    const myConfetti = window.confetti.create(confettiCanvas, { resize: true });
                    myConfetti({
                      particleCount: 200,
                      spread: 100,
                      origin: { y: 0.6 },
                      startVelocity: 30,
                      gravity: 0.8,
                      ticks: 200
                    });

                    setTimeout(() => {
                      confettiCanvas.style.pointerEvents = "none";
                      confettiCanvas.style.display = "none";
                      confettiCanvas.remove();
                    }, 6000);
                  };
                  document.body.appendChild(script);
                  // --- конец конфетти ---
                } else {
                  finalText = prizeLabel;
                }

                // Кастомное окно результата с разделением по призу
                let resultHTML = "";
                if (prizeLabel === "Joke") {
                  resultHTML = `
                    <img id="closeResult" src="close.png" alt="Закрыть" style="position: absolute; top: 10px; right: 14px; width: 18px; height: 18px; cursor: pointer;" />
                    <div style="font-family: 'Ubuntu', sans-serif; font-size: 18px; font-weight: bold; color: #DAFF9C; margin-bottom: 10px;">Вау! Ваш приз это....</div>
                    <img src="giftbox.png" alt="gift" style="width: 60px; margin: 14px auto;" />
                    <div style="font-family: 'Ubuntu', sans-serif; font-size: 10px; font-weight: 400; color: white; margin: 12px 0;">${finalText.toUpperCase()}</div>
                    <div style="font-family: 'Ubuntu', sans-serif; font-size: 16px; color: #96D52B; font-weight: bold;">ХАХАШКА</div>
                  `;
                } else if (prizeLabel === "Stripchat") {
                  // Определяем pool и isSuperPrize
                  const key = prizeLabel.toLowerCase();
                  const source = data[key];
                  const prizeRand = Math.random();
                  const pool = prizeRand < 0.9 ? source.prize : source.superprize;
                  const isSuperPrize = pool === source.superprize;
                  const prizeTypeText = isSuperPrize ? "★ SUPERPRIZE ★" : "★ PRIZE ★";
                  resultHTML = `
                    <img id="closeResult" src="close.png" alt="Закрыть" style="position: absolute; top: 10px; right: 14px; width: 18px; height: 18px; cursor: pointer;" />
                    <div style="font-family: 'Ubuntu', sans-serif; font-size: 18px; font-weight: bold; color: #DAFF9C; margin-bottom: 10px;">Вау! Ваш приз это....</div>
                    <img src="3.png" alt="Stripchat" style="width: 140px; transform: scale(1.2); margin: 14px auto; display: block;" />
                    <div style="font-family: 'Ubuntu', sans-serif; font-size: 10px; font-weight: 400; color: white; margin: 12px 0;">${finalText.toUpperCase()}</div>
                    <div style="font-family: 'Ubuntu', sans-serif; font-size: 16px; font-weight: bold; color: #96D52B; margin-top: 10px;">${prizeTypeText}</div>
                    <div style="background: rgba(255,255,255,0.08); padding: 14px; margin-top: 16px; border-radius: 10px;">
                      <div style="font-family: 'Ubuntu', sans-serif; font-size: 15px; font-weight: bold; color: white; margin-bottom: 6px;">Сделайте скриншот приза</div>
                      <div style="font-family: 'Ubuntu', sans-serif; font-size: 12px; color: #ccc;">Для получения приза, сделайте скриншот и отправьте менеджеру, нажав на кнопку внизу</div>
                    </div>
                    <button style="width: 100%; background: #96D52B; border: none; padding: 12px; color: #1F2C29; font-weight: bold; border-radius: 8px; margin-top: 12px; cursor: pointer; font-family: 'Ubuntu', sans-serif; font-size: 16px;">Забрать приз</button>
                  `;
                } else if (prizeLabel === "Chaturbate") {
                  // Общий блок для определения pool, selected и isSuperPrize
                  const key = prizeLabel.toLowerCase(); // "chaturbate"
                  const source = data[key];
                  const prizeRand = Math.random();
                  const pool = prizeRand < 0.9 ? source.prize : source.superprize;
                  const selected = pool[Math.floor(Math.random() * pool.length)];
                  const isSuperPrize = source.superprize.includes(selected);
                  const prizeTypeText = isSuperPrize ? "★ SUPERPRIZE ★" : "★ PRIZE ★";
                  finalText = `${prizeLabel}: ${selected}`;
                  resultHTML = `
                    <img id="closeResult" src="close.png" alt="Закрыть" style="position: absolute; top: 10px; right: 14px; width: 18px; height: 18px; cursor: pointer;" />
                    <div style="font-family: 'Ubuntu', sans-serif; font-size: 18px; font-weight: bold; color: #DAFF9C; margin-bottom: 10px;">Вау! Ваш приз это....</div>
                    <img src="2.png" alt="Chaturbate" style="width: 140px; transform: scale(1.2); margin: 14px auto; display: block;" />
                    <div style="font-family: 'Ubuntu', sans-serif; font-size: 10px; font-weight: 400; color: white; margin: 12px 0;">${finalText.toUpperCase()}</div>
                    <div style="font-family: 'Ubuntu', sans-serif; font-size: 16px; font-weight: bold; color: #96D52B; margin-top: 10px;">${prizeTypeText}</div>
                    <div style="background: rgba(255,255,255,0.08); padding: 14px; margin-top: 16px; border-radius: 10px;">
                      <div style="font-family: 'Ubuntu', sans-serif; font-size: 15px; font-weight: bold; color: white; margin-bottom: 6px;">Сделайте скриншот приза</div>
                      <div style="font-family: 'Ubuntu', sans-serif; font-size: 12px; color: #ccc;">Для получения приза, сделайте скриншот и отправьте менеджеру, нажав на кнопку внизу</div>
                    </div>
                    <button style="width: 100%; background: #96D52B; border: none; padding: 12px; color: #1F2C29; font-weight: bold; border-radius: 8px; margin-top: 12px; cursor: pointer; font-family: 'Ubuntu', sans-serif; font-size: 16px;">Забрать приз</button>
                  `;
                }
                resultContent.innerHTML = resultHTML;
                document.getElementById("resultOverlay").style.display = "block";
                resultFrame.style.display = "block";
                resultFrame.style.background = "#1F2C29";
                resultFrame.style.color = "white";

                // Remove any duplicated ✖️ close button if present
                const closeSpan = resultContent.querySelector('.close-btn');
                if (closeSpan) closeSpan.remove();

                // Add event listener for new closeResult image
                const closeResultImg = resultContent.querySelector('#closeResult');
                if (closeResultImg) {
                  closeResultImg.addEventListener("click", () => {
                    document.getElementById("resultOverlay").style.display = "none";
                    resultFrame.style.display = "none";
                    location.reload(); // Перезагрузка страницы
                  });
                }

                if (window.wasSpinGrantedByFreespin) {
                  // Сначала списываем фриспин
                  fetch("https://script.google.com/macros/s/AKfycbxplvQPVt_IIyJXPEoPNlS1SXBNuHmQOvr5xwUqy9zJEX0xtyF2RvsZxRjCK94evoAlvw/exec", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({
                      action: "minusValue",
                      user_id: userId
                    })
                  })
                  .then(res => res.text())
                  .then(resultMinus => {
                    console.log("Фриспин списан:", resultMinus);

                    // Затем записываем приз, если списание прошло
                    fetch("https://script.google.com/macros/s/AKfycbxplvQPVt_IIyJXPEoPNlS1SXBNuHmQOvr5xwUqy9zJEX0xtyF2RvsZxRjCK94evoAlvw/exec", {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                      },
                      body: new URLSearchParams({
                        action: "addValue",
                        username: username,
                        user_id: userId,
                        prize: finalText,
                        ip: ip,
                      })
                    })
                    .then(res => res.text())
                    .then(resultAdd => console.log("Приз записан:", resultAdd))
                    .catch(err => console.error("Ошибка при записи приза:", err));
                  })
                  .catch(err => console.error("Ошибка при списании фриспина:", err));
                }

                document.getElementById("spinBtn").style.pointerEvents = "none";

                if (!window.wasSpinGrantedByFreespin) {
                  const finalPayload = new URLSearchParams({
                    action: "savePrize",
                    username: username,
                    user_id: userId,
                    prize: finalText,
                    ip: ip
                  });

                  fetch("https://script.google.com/macros/s/AKfycbxplvQPVt_IIyJXPEoPNlS1SXBNuHmQOvr5xwUqy9zJEX0xtyF2RvsZxRjCK94evoAlvw/exec", {
                    method: "POST",
                    body: finalPayload.toString(),
                    headers: {
                      "Content-Type": "application/x-www-form-urlencoded"
                    }
                  }).catch(err => {
                    console.error("❌ Не удалось записать приз:", err);
                  });
                }
              });
            spinButton.style.pointerEvents = "auto";
            spinButton.disabled = false;
            spinButton.classList.remove("spinning");
          }, spinDuration * 1000 + 10);
        });
    });

  // NOTE: closeResult event is now attached dynamically after resultContent.innerHTML is set.

    loadImages(drawWheel);

    window.addEventListener("DOMContentLoaded", async () => {
      const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
      if (!tgUser || !tgUser.id) return;

      const isAvailable = await fetch(`https://your-backend.com/check?id=${tgUser.id}`)
        .then(res => res.json())
        .then(data => data.available)
        .catch(() => false);

      if (isAvailable) {
        document.getElementById("startModal").style.display = "flex";
      }
    });


    window.addEventListener("DOMContentLoaded", () => {
      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.expand();
      }
      document.getElementById("mainContent").style.display = "none";
      document.getElementById("loader").style.display = "flex";
      const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
      if (!tgUser || !tgUser.id) {
        const resultFrame = document.getElementById("resultText");
        const resultContent = document.getElementById("resultContent");
        resultContent.innerHTML = `
          <p>Пожалуйста, сначала нажмите "start" у бота в Telegram</p>
          <a href="https://t.me/rollcam_bot" target="_blank" style="color: #6C5CFE; font-weight: bold;">Нажмите сюда</a>
        `;
        resultFrame.style.display = "block";
        setTimeout(() => {
          resultFrame.style.display = "none";
        }, 10000);
        return;
      }

      const username = tgUser.username || "unknown";
      const userId = tgUser.id || "unknown";

      // const username = "unknown";
      // const userId = "unknown";

      fetch("https://api.ipify.org?format=json")
        .then(res => res.json())
        .then(data => {
          const ip = data.ip;

          let payload = new URLSearchParams({
            action: "savePrize",
            username: username,
            user_id: userId,
            prize: "check",
            ip: ip
          });

          fetch("https://script.google.com/macros/s/AKfycbxplvQPVt_IIyJXPEoPNlS1SXBNuHmQOvr5xwUqy9zJEX0xtyF2RvsZxRjCK94evoAlvw/exec", {
            method: "POST",
            body: payload.toString(),
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            }
          }).then(res => res.text()).then(text => {
            if (text.startsWith("Too Soon|")) {
              const millisLeft = parseInt(text.split("|")[1], 10);
              // Вставляем функцию и запуск таймера сразу после парсинга millisLeft
              function startCountdown(msLeft) {
                const countdownSpan = document.getElementById("countdownTimer");
                if (!countdownSpan) return;

                function updateTimer(ms) {
                  const totalSeconds = Math.floor(ms / 1000);
                  const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                  const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                  const s = String(totalSeconds % 60).padStart(2, '0');
                  countdownSpan.textContent = `${h}:${m}:${s}`;
                  // Обновляем таймер в модальном окне, если он есть
                  const modalTimer = document.getElementById("modalCountdownTimer");
                  if (modalTimer) modalTimer.textContent = `${h}:${m}:${s}`;
                }

                let remaining = msLeft;
                updateTimer(remaining);
                const timerInterval = setInterval(() => {
                  remaining -= 1000;
                  if (remaining <= 0) {
                    clearInterval(timerInterval);
                    countdownSpan.textContent = "00:00:00";
                    const modalTimer = document.getElementById("modalCountdownTimer");
                    if (modalTimer) modalTimer.textContent = "00:00:00";
                  } else {
                    updateTimer(remaining);
                  }
                }, 1000);
              }
              // Запустить таймер сразу после первого ответа
              startCountdown(millisLeft);

              const loader = document.getElementById("loader");
              const mainContent = document.getElementById("mainContent");
              const resultFrame = document.getElementById("resultText");
              const resultContent = document.getElementById("resultContent");

              // Also hide result overlay if showing
              document.getElementById("resultOverlay").style.display = "none";
              mainContent.style.display = "none";

              // Новый fetch к getValue
              fetch("https://script.google.com/macros/s/AKfycbxplvQPVt_IIyJXPEoPNlS1SXBNuHmQOvr5xwUqy9zJEX0xtyF2RvsZxRjCK94evoAlvw/exec", {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                  action: "getValue",
                  user_id: userId
                })
              })
              .then(res => res.text())
              .then(result => {
                const num = result.includes("Error") ? 0 : parseInt(result, 10) || 0;
                document.getElementById("friendsCount").textContent = num;
                if (!isNaN(num) && num > 0) {
                  window.wasSpinGrantedByFreespin = true;
                  document.getElementById("loader").style.display = "none";
                  document.getElementById("mainContent").style.display = "block";
                  document.getElementById("resultOverlay").style.display = "none";
                } else {
                  // Показываем mainContent и прячем loader
                  document.getElementById("loader").style.display = "none";
                  document.getElementById("mainContent").style.display = "block";
                  document.getElementById("resultOverlay").style.display = "none";
                  document.getElementById("spinBtn").style.pointerEvents = "none";
                  // Показываем модальное окно "нет спинов"
                  document.getElementById("noSpinsModal").style.display = "block";
                  document.getElementById("modalOverlay").style.display = "block";
                  // Таймер уже запущен выше
                  console.log("Ответ от сервера:", text);
                  console.log("Осталось миллисекунд:", millisLeft);
                }
              })
              .catch(err => {
                console.error("Ошибка при проверке getValue:", err);
              });
            } else {
              window.wasSpinGrantedByFreespin = false;
              document.getElementById("yesSpinModal").style.display = "block";
              document.getElementById("modalOverlayStart").style.display = "block";

              document.getElementById("loader").style.display = "none";
              document.getElementById("mainContent").style.display = "block";
              document.getElementById("resultOverlay").style.display = "none";
            }
          });
        });
    // Обработчик закрытия модального окна "нет спинов"
    document.getElementById("closeNoSpins").addEventListener("click", () => {
      document.getElementById("modalOverlay").style.display = "none";
      document.getElementById("noSpinsModal").style.display = "none";
    });
    // Обработчик закрытия модального окна "разрешён спин"
    if (document.getElementById("closeYesSpin")) {
      document.getElementById("closeYesSpin").addEventListener("click", () => {
        document.getElementById("modalOverlay").style.display = "none";
        document.getElementById("yesSpinModal").style.display = "none";
        document.getElementById("modalOverlayStart").style.display = "none";
      });
    }
    document.getElementById("startSpinBtn").addEventListener("click", function () {
      document.getElementById("modalOverlayStart").style.display = "none";
    });

    // --- Invite friends button handler with toast ---
    document.getElementById("inviteBtnMain").addEventListener("click", copyLink);
    document.getElementById("inviteBtnModal").addEventListener("click", copyLink);
    document.getElementById("inviteBtnModalStart").addEventListener("click", copyLink);
    // Invite button in modalAccessGranted (added below)
    
    if (document.getElementById("inviteBtn")) {
      document.getElementById("inviteBtn").addEventListener("click", copyLink);
    }

    function copyLink() {
      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
      // const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || { id: "123456789" };
      if (!tgUser || !tgUser.id) return;

      const link = `https://t.me/rollcam_bot?start=${tgUser.id}`;
      navigator.clipboard.writeText(link).then(() => {
        const toast = document.getElementById("toast");
        toast.style.opacity = "1";
        setTimeout(() => {
          toast.style.opacity = "0";
        }, 3000);
      });
    }

    // showToast function (if not exists)
    function showToast(msg) {
      const toast = document.getElementById("resultText");
      document.getElementById("resultContent").textContent = msg;
      toast.style.display = "block";
      setTimeout(() => {
        toast.style.display = "none";
      }, 5000);
    }
    // --- Spin button animation: spinAndPulse + pulse ---
    function startSpinAnimation() {
      const spinBtn = document.getElementById("spinBtn");
      spinBtn.classList.remove("spin-active");
      void spinBtn.offsetWidth; // принудительный reflow
      spinBtn.classList.add("spin-active");

      setTimeout(() => {
        spinBtn.classList.remove("spin-active");
      }, 1000); // убрать анимации после 2 сек
    }
  });
  </script>
</body>
</html>

